package com.rainbowmobiles.suggest;

import java.util.Properties;

import javax.mail.Message;
import javax.mail.MessagingException;
import javax.mail.Session;
import javax.mail.Transport;
import javax.mail.internet.InternetAddress;
import javax.mail.internet.MimeMessage;

import android.accounts.Account;
import android.accounts.AccountManager;
import android.app.Activity;
import android.os.Bundle;
import android.util.Log;
import android.view.View;
import android.widget.Button;
import android.widget.EditText;
import android.widget.Toast;

public class MainActivity extends Activity {

	EditText userName;
	EditText msg;
	EditText userPhoneNo;
	EditText date;
	EditText invoiceNo;
	String possibleEmail;

	@Override
	protected void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);

		setContentView(R.layout.activity_main);
		initWidgets();
		invokeRegisteredMail();
		Button login = (Button) findViewById(R.id.sendbtn);
		login.setOnClickListener(new View.OnClickListener() {

			public void onClick(View arg0) {

				String inputUserName = userName.getText().toString();
				String inputPhoneNo = userPhoneNo.getText().toString();
				String inputDate = date.getText().toString();
				String inputInvoiceNo = invoiceNo.getText().toString();
				String inputIssueDetails = msg.getText().toString();
				
				try {
					Message message = new MimeMessage(MyGmailSession.getMyGmailSession());
					String userEmail = UserEmailFetcher.getEmail(getApplicationContext());
					message.setFrom(new InternetAddress(userEmail));
					message.setRecipients(Message.RecipientType.TO,
							InternetAddress.parse(ApplicationConstants.GMAIL_COMPLIANT_EMAIL_TO));

					StringBuilder emailSubject = new StringBuilder(
							"Compliant - ");
					emailSubject.append("Name::" + inputUserName + ", ");
					emailSubject.append("Phone No::" + inputPhoneNo + ", ");
					emailSubject.append("Date::" + inputDate + ", ");
					emailSubject.append("Invoice No::" + inputInvoiceNo);
					message.setSubject(emailSubject.toString());
					StringBuilder emailMessage = new StringBuilder(
							"<html><body style=\"font-family:sans-serif Arial\">");
					emailMessage
							.append("<div style=\"font-weight:normal; font-size:100%\">");
					emailMessage.append("Name::" + inputUserName + "<br/> ");
					emailMessage.append("Phone No::" + inputPhoneNo + "<br/> ");
					emailMessage.append("Date::" + inputDate + "<br/> ");
					emailMessage.append("Invoice No::" + inputInvoiceNo
							+ "<br/> ");
					emailMessage.append("Issue Summary::" + inputIssueDetails
							+ "<br/><br/><br/> ");
					emailMessage.append("</div>");
					emailMessage
							.append("<div style=\"font-weight:normal; font-size:75%\">");
					emailMessage.append("Thanks," + "<br/> ");
					emailMessage.append("Issue Reported from AndroidApp");
					emailMessage.append("</div>");
					emailMessage.append("</body></html>");
					message.setContent(emailMessage.toString(),
							"text/html; charset=utf-8");

					Transport.send(message);
					Toast.makeText(getApplicationContext(),
							"Message has been sent", Toast.LENGTH_SHORT).show();
				} catch (MessagingException e) {
					throw new RuntimeException(e);
				}
			}
		});
	}

	/**
 * 
 */
	private void invokeRegisteredMail() {

		try {
			Account[] accounts = AccountManager.get(this).getAccountsByType(
					"com.google");

			for (Account account : accounts) {

				possibleEmail += account.name;

			}
		} catch (Exception e) {
			Log.i("Exception", "Exception:" + e);
		}

	}

	private void initWidgets() {
		userName = (EditText) findViewById(R.id.userName);
		msg = (EditText) findViewById(R.id.message);
		userPhoneNo = (EditText) findViewById(R.id.userPhNo);
		date = (EditText) findViewById(R.id.userDate);
		invoiceNo = (EditText) findViewById(R.id.userInvoiceNo);
	}
}
